<?php
ini_set('mx_execution_time', 3600);

require_once "./class/config.class.php";
require_once "./class/driver.class.php";
require_once "./class/functions.class.php";

define('APPLICATION_PATH', __DIR__);

$get = filter_input_array(INPUT_GET);
if (!isset($get['id']) && !$get['id']) {
    die('please specify a video id');
}

$config = new Config();
$settings = $config->getDBAccess();
try {
    $db = new PDO(Driver::loadDriver($settings['db']['type'], $settings['db']['host'], $settings['db']['db_name'], $settings['db']['path']), $settings['db']['username'], $settings['db']['password']);
    $db->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);
    $db->setAttribute(PDO::ATTR_EMULATE_PREPARES, false);
    $db->setAttribute(PDO::ATTR_DEFAULT_FETCH_MODE, PDO::FETCH_ASSOC);
} catch (PDOException $ex) {
    echo $ex->getMessage();
    exit;
}
$statement = $db->prepare("SELECT `path`,`type` FROM `uploads` WHERE `id`=:id");
$bind = array(
    ':id' => $get['id']
    );
$statement->execute($bind);
$result = $statement->fetch();
if (empty($result)) {
    die('There is no video with id ' . $get['id']);
}
$url = getBaseUrl()."/".$result['path']."?token=".md5(time());
$type= $result['type'];
$yt = $result['path'];
if ($url) {
    ?>
    <html>
    <head>
        <title>Video</title>
        <link href="//vjs.zencdn.net/4.6/video-js.css" rel="stylesheet">
        <style>
            /* Video.js Controls Style Overrides */

        </style>
        <script type="text/javascript">
            var path = "<?=getPath()?>";
        </script>
    </head>
    <body>
       <?php
       if($type == 'youtube'){
        ?>
        <video id="vimeo_yt_player" class="video-js vjs-default-skin" autoplay="autoplay" controls preload="auto" width="500" height="350"
        data-setup='{"techOrder": ["youtube"], "src": "<?=$yt?>"}'>
        </video>
        <?php } else { ?>
        <video id="vimeo_player" class="video-js vjs-default-skin" autoplay="autoplay" controls preload="auto" width="500" height="350"
        data-setup='{"example_option":true}'>
        <source src="<?= $url ?>" type='video/<?= $type ?>' />
            <object type="application/x-shockwave-flash" data="http://releases.flowplayer.org/swf/flowplayer-3.2.1.swf" width="500" height="350">
                <param name="movie" value="http://releases.flowplayer.org/swf/flowplayer-3.2.1.swf" />
                <param name="allowFullScreen" value="true" />
                <param name="wmode" value="transparent" />
                <param name="flashVars" value="config={'playlist':['img/genericvideoicon.jpg',{'url':'".<?=urlencode($url)?>."','autoPlay':false}]}" />
                <img alt="SoarMorrow video player" src="img/genericvideoicon.jpg" width="640" height="360" title="No video playback capabilities, please download the video below" />
            </object>
            <p class="vjs-no-js">To view this video please enable JavaScript, and consider upgrading to a web browser that <a href="http://videojs.com/html5-video-support/" target="_blank">supports HTML5 video</a></p>
        </video>

        <?php
    }
    ?>
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
    <script src="//vjs.zencdn.net/4.6/video.js"></script>
    <script src="js/youtube.js"></script>
</body>
</html>
<?php
} else {
    die("something wrong happened");
}
?>
